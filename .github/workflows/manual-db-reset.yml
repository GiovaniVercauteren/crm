name: Manual DB Reset

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type RESET to confirm dropping all database data"
        required: true
        type: string
      target_env:
        description: "Target environment label"
        required: true
        default: "production"
        type: choice
        options:
          - production

jobs:
  reset-db:
    name: Drop and recreate Postgres database
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation input
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "RESET" ]; then
            echo "Confirmation mismatch. Type RESET to run this workflow."
            exit 1
          fi

      - name: Drop and recreate database
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            set -euo pipefail

            cd "/containers/${{ github.repository }}"

            docker compose up -d db

            docker compose exec -T db sh -lc 'psql -v ON_ERROR_STOP=1 -U "$POSTGRES_USER" -d postgres -c "DROP DATABASE IF EXISTS \"$POSTGRES_DB\" WITH (FORCE);"'
            docker compose exec -T db sh -lc 'psql -v ON_ERROR_STOP=1 -U "$POSTGRES_USER" -d postgres -c "CREATE DATABASE \"$POSTGRES_DB\" OWNER \"$POSTGRES_USER\";"'
